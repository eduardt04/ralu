<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Learn Tracker - Dashboard</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="dashboard">
    <aside class="sidebar">
      <h2>📘 Learn Tracker</h2>
      <nav>
        <ul>
          <li class="active" onclick="showTab('session')">📖 Learning Session</li>
          <li onclick="showTab('history')">🕒 History</li>
        </ul>
      </nav>
    </aside>

    <main class="content">
      <section id="session-tab" class="tab">
        <h1>Learning Session</h1>
        <div id="timer">00:00:00</div>
        <div class="timer-buttons">
          <button onclick="startTimer()">Start Session</button>
          <button onclick="pauseTimer()">Pause Session</button>
          <button onclick="endSession()">End Session</button>
        </div>
      </section>

      <section id="history-tab" class="tab" style="display: none;">
        <h1>History</h1>
        <p>Coming soon...</p>
      </section>
    </main>
  </div>

  <!-- End Session Popup -->
  <div id="end-session-popup" class="popup">
    <form onsubmit="event.preventDefault(); saveSession();">
      <span class="close-popup" onclick="closePopups()">←</span>
      <h2>End of Session</h2>
      <label>Chapter:</label>
      <input type="text" id="chapter" required />
      <label>Number of Pages:</label>
      <input type="number" id="pages" required />
      <label>Satisfaction Rating:</label>
      <select id="satisfaction" required>
        <option value="">Select</option>
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select>
      <button type="submit">Save Session</button>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD2uPoY_qjkq-G2MKBkwufZBJpE2eYNyIs",
      authDomain: "learntracker-9c9c4.firebaseapp.com",
      databaseURL: "https://learntracker-9c9c4-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "learntracker-9c9c4",
      storageBucket: "learntracker-9c9c4.firebasestorage.app",
      messagingSenderId: "475357749034",
      appId: "1:475357749034:web:3b105bdce10746bb5d8853"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let timerInterval, totalSeconds = 0, startTime;

    function showTab(tab) {
      document.querySelectorAll(".tab").forEach(t => t.style.display = "none");
      document.getElementById(tab + "-tab").style.display = "block";
      document.querySelectorAll(".sidebar li").forEach(li => li.classList.remove("active"));
      document.querySelector(`.sidebar li[onclick="showTab('${tab}')"]`).classList.add("active");
    }

    function startTimer() {
      if (!timerInterval) {
        startTime = new Date();
        timerInterval = setInterval(() => {
          totalSeconds++;
          const hrs = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
          const mins = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
          const secs = String(totalSeconds % 60).padStart(2, '0');
          document.getElementById("timer").textContent = `${hrs}:${mins}:${secs}`;
        }, 1000);
      }
    }

    function pauseTimer() {
      clearInterval(timerInterval);
      timerInterval = null;
    }

    function endSession() {
      pauseTimer();
      document.getElementById("end-session-popup").style.display = "block";
    }

    window.saveSession = async function () {
      const chapter = document.getElementById("chapter").value;
      const pages = document.getElementById("pages").value;
      const satisfaction = document.getElementById("satisfaction").value;

      const duration = totalSeconds;
      totalSeconds = 0;
      document.getElementById("timer").textContent = "00:00:00";

      onAuthStateChanged(auth, async user => {
        if (user) {
          const sessionData = {
            chapter,
            pages,
            satisfaction,
            duration,
            endedAt: new Date().toISOString()
          };
          await push(ref(db, "sessions/" + user.uid), sessionData);
          alert("Session saved!");
          closePopups();
        } else {
          alert("User not logged in.");
        }
      });
    };

    window.closePopups = function () {
      document.getElementById("end-session-popup").style.display = "none";
    };
  </script>
</body>
</html>